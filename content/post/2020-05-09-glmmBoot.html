---
title: "Mixed Poisson Example with `glmmBoot`"
author: "Daniel Flores Agreda"
date: 09-05-2020
categories: ["R"]
tags: ["glmmBoot", "Bootstrap"]
---



<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<p>This code to illustrates the implementation of the bootstrapping methods described in <a href="https://www.researchgate.net/publication/315768128_Bootstrapping_Generalized_Linear_Mixed_Models_via_a_Weighted_Laplace_Approximation">(Flores-Agreda and Cantoni, Under Review)</a> in a real-data context. Data comes from the  example found in <a href="https://www.springer.com/gp/book/9780387251448">Molenberghs &amp; Verbeke (2006)</a> initially reported by <a href="https://www.ncbi.nlm.nih.gov/pubmed/8649570">Faught et. al. (1996)</a>.</p>
<div id="analysis" class="section level2">
<h2>Analysis</h2>
<p>To start performing the analysis, you need:</p>
<ol style="list-style-type: decimal">
<li><p>the following packages:</p></li>
<li>to compile <code>glmm_rirs.cpp</code> and load the resulting binary into the environment:</li>
</ol>
<pre class="r"><code>compile(file = &quot;glmmBoot/src/glmm_rirs.cpp&quot;)
dyn.load(dynlib(&quot;glmmBoot/src/glmm_rirs&quot;))</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>the functions in the file <code>glmmBoot.R</code>:</li>
</ol>
<pre class="r"><code>source(&quot;glmmBoot/R/glmmBoot.R&quot;)</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>the dataset <code>epilepsy.sas7bdat</code></li>
</ol>
<pre class="r"><code>epilepsy &lt;- read.sas7bdat(file = &quot;glmmBoot/data/epilepsy.sas7bdat&quot;)</code></pre>
</div>
<div id="model" class="section level2">
<h2>Model</h2>
<p>The aim of the study was to verify the effects of an new anti-epileptic drug (AED) compared to a placebo on the number of seizures experienced by patients during the study. To do this, consider a mixed Poisson model for the outcome containing two potentially correlated random effects: one for a random intercept and another one for the visit time i.e. <span class="math inline">\(y_{ij}|\mathbf{u}_i\sim \mathcal{P}(\lambda_{ij})\)</span> with:</p>
<p><span class="math display">\[\log(\lambda_{ij}) = \beta_0  + \beta_{1} T_{ij} + \beta_{2}t_{ij} + \beta_{3} T_{ij}t_{ij} +  \sigma_{1} u_{i1}  + \sigma_{2} u_{i2} t_{ij}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(T_{ij}\)</span> represents the effect of the treatment and</li>
<li><span class="math inline">\(t_{ij}\)</span> the visit time.</li>
</ul>
<p>The variance-covariance structure of the vector of Normal random effects <span class="math inline">\(\mathbf{u}_i = [u_{i1}, u_{i2}]^T\)</span>, comprises a correlation coefficient <span class="math inline">\(\rho\)</span> , i.e.</p>
<p><span class="math display">\[\mathbf{D}(\mathbf{\sigma}) = \left[\begin{array}{c c} \sigma_{1}^2 &amp; \rho\sigma_{1}\sigma_{2} \\  \rho\sigma_{1}\sigma_{2} &amp; \sigma_{2}^2 \end{array}\right]\]</span>.</p>
</div>
<div id="implementation" class="section level2">
<h2>Implementation</h2>
<div id="estimate_glmm" class="section level3">
<h3><code>estimate_glmm()</code></h3>
<p>The function <code>estimate_glmm()</code> estimates the model with a <code>TMB</code> template using the frame and estimates of objects of class <code>glmerMod</code> as starting values. For example:</p>
<pre class="r"><code>obj.glmerMod &lt;- lme4::glmer(nseizw~ trt*studyweek + (studyweek|id), 
                            family = &quot;poisson&quot;,
                            data = epilepsy, 
                            control = glmerControl(optimizer = &quot;bobyqa&quot;))</code></pre>
<p>for comparison purposes, let us also extract the estimates of this object</p>
<p>A comparison of the estimates yields:</p>
<pre class="r"><code>est_lmer %&gt;% 
  inner_join(est_tmb, by=(&quot;Parameters&quot;), suffix=c(&quot; (glmer)&quot;, &quot; (TMB)&quot;)) </code></pre>
<pre><code>##      Parameters Estimates (glmer) Std..Errors (glmer) Estimates (TMB)
## 1   (Intercept)        0.89453458         0.178197278      0.89448691
## 2           trt       -0.24426928         0.253821873     -0.24430693
## 3     studyweek       -0.02714197         0.009853964     -0.02714537
## 4 trt:studyweek        0.01067094         0.013847413      0.01067169
## 5           s_1        1.12719788                  NA      1.12727064
## 6           s_2        0.04871365                  NA      0.04871505
## 7           rho       -0.33392838                  NA     -0.33387741
##   Std..Errors (TMB)
## 1       0.178577727
## 2       0.254354415
## 3       0.009920947
## 4       0.013933258
## 5       0.097487891
## 6       0.005702102
## 7       0.131163744</code></pre>
<p>The generation of replicates using Random Weighted Laplace Bootstrap <a href="https://www.researchgate.net/publication/315768128_Bootstrapping_Generalized_Linear_Mixed_Models_via_a_Weighted_Laplace_Approximation">(Flores-Agreda and Cantoni, Under Review)</a> is carried by the function <code>bootstrap_glmm()</code>, with the option <code>method=rwlb</code>.</p>
<pre class="r"><code>## Bootstrap inference 
rwlb_reps &lt;- bootstrap_glmm(obj.glmerMod,
                            B = 1000,
                            method = &quot;rwlb&quot;)</code></pre>
<p>The resulting Bootstrap replicates are stored in an object of the class <code>glmmBoot</code>, which can be used to construct</p>
<ul>
<li>Estimates of the Parameters: by averaging over the replicates</li>
<li>Estimates of the Standard Errors: by computing the standard deviations for the replicates and</li>
<li>Percentile-based Confidence Intervals (CI) with a level of 95%.</li>
</ul>
</div>
</div>
<div id="methods" class="section level2">
<h2>Methods</h2>
<div id="confint" class="section level3">
<h3><code>confint()</code></h3>
<p>produces bootstrap estimates, standard errors and confidence intervals with the <code>percentile</code> and <code>studentized</code> methods</p>
<ul>
<li>Example of the percentile method</li>
</ul>
<pre class="r"><code>rwlb_reps %&gt;% 
  confint(bootstrap_type = &quot;percentile&quot;)</code></pre>
<pre><code>## # A tibble: 7 x 5
##   Parameters    Estimate Std_Errors ci_lower ci_upper
##   &lt;fct&gt;            &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)     0.890     0.153     0.601   1.19   
## 2 rho            -0.322     0.166    -0.641  -0.00910
## 3 s_1             1.11      0.129     0.892   1.40   
## 4 s_2             0.0477    0.00737   0.0336  0.0631 
## 5 studyweek      -0.0269    0.00881  -0.0445 -0.0105 
## 6 trt            -0.243     0.252    -0.710   0.253  
## 7 trt:studyweek   0.0104    0.0130   -0.0158  0.0370</code></pre>
<ul>
<li>Example of the studentized method</li>
</ul>
<pre class="r"><code>rwlb_reps %&gt;% 
  confint(bootstrap_type = &quot;studentized&quot;)</code></pre>
<pre><code>## # A tibble: 7 x 5
##   Parameters    Estimate Std_Errors ci_lower ci_upper
##   &lt;fct&gt;            &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)     0.890     0.153     0.608   1.20   
## 2 rho            -0.322     0.166    -0.769  -0.0487 
## 3 s_1             1.11      0.129     0.840   1.34   
## 4 s_2             0.0477    0.00737   0.0319  0.0603 
## 5 studyweek      -0.0269    0.00881  -0.0439 -0.00923
## 6 trt            -0.243     0.252    -0.724   0.255  
## 7 trt:studyweek   0.0104    0.0130   -0.0169  0.0365</code></pre>
</div>
<div id="plot" class="section level3">
<h3><code>plot()</code></h3>
<p>Shows the boxplots of the replicates for all the parameters or a subset with a line describing the TMB estimates</p>
<ul>
<li>fixed effect parameters</li>
</ul>
<pre class="r"><code>plot(rwlb_reps, 
     parm_subset=c(&quot;(Intercept)&quot;, &quot;trt&quot;, &quot;studyweek&quot;, &quot;trt:studyweek&quot;)) + 
  ggtitle(&quot;Replicates of Fixed Effects&quot;) +
  theme_classic()</code></pre>
<p><img src="/post/2020-05-09-glmmBoot_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<ul>
<li>variances of random effects</li>
</ul>
<pre class="r"><code>plot(rwlb_reps, 
     parm_subset=c(&quot;s_1&quot;, &quot;s_2&quot;, &quot;rho&quot;)) + 
  ggtitle(&quot;Replicates of Variance Components&quot;)+theme_classic()</code></pre>
<p><img src="/post/2020-05-09-glmmBoot_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
</div>
